const P={},X=(e,n)=>e.unstable_is?e.unstable_is(n):n===e,Y=e=>"init"in e,$=e=>!!e.write,Z=e=>"v"in e||"e"in e,U=e=>{if("e"in e)throw e.e;if((P?"production":void 0)!=="production"&&!("v"in e))throw new Error("[Bug] atom state is not initialized");return e.v},V=new WeakMap,B=e=>{var n;return j(e)&&!!((n=V.get(e))!=null&&n[0])},ee=e=>{const n=V.get(e);n?.[0]&&(n[0]=!1,n[1].forEach(r=>r()))},k=(e,n)=>{let r=V.get(e);if(!r){r=[!0,new Set],V.set(e,r);const l=()=>{r[0]=!1};e.then(l,l)}r[1].add(n)},j=e=>typeof e?.then=="function",F=(e,n,r)=>{r.p.has(e)||(r.p.add(e),n.then(()=>{r.p.delete(e)},()=>{r.p.delete(e)}))},G=(e,n,r)=>{const l=r(e),_="v"in l,f=l.v;if(j(n))for(const u of l.d.keys())F(e,n,r(u));l.v=n,delete l.e,(!_||!Object.is(f,l.v))&&(++l.n,j(f)&&ee(f))},C=(e,n,r)=>{var l;const _=new Set;for(const f of((l=r.get(e))==null?void 0:l.t)||[])r.has(f)&&_.add(f);for(const f of n.p)_.add(f);return _},te=()=>{const e=new Set,n=()=>{e.forEach(r=>r())};return n.add=r=>(e.add(r),()=>{e.delete(r)}),n},K=()=>{const e={},n=new WeakMap,r=l=>{var _,f;(_=n.get(e))==null||_.forEach(u=>u(l)),(f=n.get(l))==null||f.forEach(u=>u())};return r.add=(l,_)=>{const f=l||e,u=(n.has(f)?n:n.set(f,new Set)).get(f);return u.add(_),()=>{u?.delete(_),u.size||n.delete(f)}},r},ne=e=>(e.c||(e.c=K()),e.m||(e.m=K()),e.u||(e.u=K()),e.f||(e.f=te()),e),re=Symbol(),ie=(e=new WeakMap,n=new WeakMap,r=new WeakMap,l=new Set,_=new Set,f=new Set,u={},w=(a,...S)=>a.read(...S),E=(a,...S)=>a.write(...S),b=(a,S)=>{var y;return(y=a.unstable_onInit)==null?void 0:y.call(a,S)},A=(a,S)=>{var y;return(y=a.onMount)==null?void 0:y.call(a,S)},...g)=>{const a=g[0]||(t=>{if((P?"production":void 0)!=="production"&&!t)throw new Error("Atom is undefined or null");let d=e.get(t);return d||(d={d:new Map,p:new Set,n:0},e.set(t,d),b?.(t,M)),d}),S=g[1]||(()=>{const t=[],d=c=>{try{c()}catch(o){t.push(o)}};do{u.f&&d(u.f);const c=new Set,o=c.add.bind(c);l.forEach(i=>{var s;return(s=n.get(i))==null?void 0:s.l.forEach(o)}),l.clear(),f.forEach(o),f.clear(),_.forEach(o),_.clear(),c.forEach(d),l.size&&y()}while(l.size||f.size||_.size);if(t.length)throw new AggregateError(t)}),y=g[2]||(()=>{const t=[],d=new WeakSet,c=new WeakSet,o=Array.from(l);for(;o.length;){const i=o[o.length-1],s=a(i);if(c.has(i)){o.pop();continue}if(d.has(i)){if(r.get(i)===s.n)t.push([i,s]);else if((P?"production":void 0)!=="production"&&r.has(i))throw new Error("[Bug] invalidated atom exists");c.add(i),o.pop();continue}d.add(i);for(const h of C(i,s,n))d.has(h)||o.push(h)}for(let i=t.length-1;i>=0;--i){const[s,h]=t[i];let p=!1;for(const D of h.d.keys())if(D!==s&&l.has(D)){p=!0;break}p&&(T(s),W(s)),r.delete(s)}}),T=g[3]||(t=>{var d;const c=a(t);if(Z(c)&&(n.has(t)&&r.get(t)!==c.n||Array.from(c.d).every(([v,O])=>T(v).n===O)))return c;c.d.clear();let o=!0;const i=()=>{n.has(t)&&(W(t),y(),S())},s=v=>{var O;if(X(t,v)){const Q=a(v);if(!Z(Q))if(Y(v))G(v,v.init,a);else throw new Error("no atom init");return U(Q)}const x=T(v);try{return U(x)}finally{c.d.set(v,x.n),B(c.v)&&F(t,c.v,x),(O=n.get(v))==null||O.t.add(t),o||i()}};let h,p;const D={get signal(){return h||(h=new AbortController),h.signal},get setSelf(){return(P?"production":void 0)!=="production"&&!$(t)&&console.warn("setSelf function cannot be used with read-only atom"),!p&&$(t)&&(p=(...v)=>{if((P?"production":void 0)!=="production"&&o&&console.warn("setSelf function cannot be called in sync"),!o)try{return I(t,...v)}finally{y(),S()}}),p}},N=c.n;try{const v=w(t,s,D);return G(t,v,a),j(v)&&(k(v,()=>h?.abort()),v.then(i,i)),c}catch(v){return delete c.v,c.e=v,++c.n,c}finally{o=!1,N!==c.n&&r.get(t)===N&&(r.set(t,c.n),l.add(t),(d=u.c)==null||d.call(u,t))}}),J=g[4]||(t=>{const d=[t];for(;d.length;){const c=d.pop(),o=a(c);for(const i of C(c,o,n)){const s=a(i);r.set(i,s.n),d.push(i)}}}),I=g[5]||((t,...d)=>{let c=!0;const o=s=>U(T(s)),i=(s,...h)=>{var p;const D=a(s);try{if(X(t,s)){if(!Y(s))throw new Error("atom not writable");const N=D.n,v=h[0];G(s,v,a),W(s),N!==D.n&&(l.add(s),(p=u.c)==null||p.call(u,s),J(s));return}else return I(s,...h)}finally{c||(y(),S())}};try{return E(t,o,i,...d)}finally{c=!1}}),W=g[6]||(t=>{var d;const c=a(t),o=n.get(t);if(o&&!B(c.v)){for(const[i,s]of c.d)if(!o.d.has(i)){const h=a(i);z(i).t.add(t),o.d.add(i),s!==h.n&&(l.add(i),(d=u.c)==null||d.call(u,i),J(i))}for(const i of o.d||[])if(!c.d.has(i)){o.d.delete(i);const s=R(i);s?.t.delete(t)}}}),z=g[7]||(t=>{var d;const c=a(t);let o=n.get(t);if(!o){T(t);for(const i of c.d.keys())z(i).t.add(t);if(o={l:new Set,d:new Set(c.d.keys()),t:new Set},n.set(t,o),(d=u.m)==null||d.call(u,t),$(t)){const i=()=>{let s=!0;const h=(...p)=>{try{return I(t,...p)}finally{s||(y(),S())}};try{const p=A(t,h);p&&(o.u=()=>{s=!0;try{p()}finally{s=!1}})}finally{s=!1}};_.add(i)}}return o}),R=g[8]||(t=>{var d;const c=a(t);let o=n.get(t);if(o&&!o.l.size&&!Array.from(o.t).some(i=>{var s;return(s=n.get(i))==null?void 0:s.d.has(t)})){o.u&&f.add(o.u),o=void 0,n.delete(t),(d=u.u)==null||d.call(u,t);for(const i of c.d.keys()){const s=R(i);s?.t.delete(t)}return}return o}),m=[e,n,r,l,_,f,u,w,E,b,A,a,S,y,T,J,I,W,z,R],M={get:t=>U(T(t)),set:(t,...d)=>{try{return I(t,...d)}finally{y(),S()}},sub:(t,d)=>{const o=z(t).l;return o.add(d),S(),()=>{o.delete(d),R(t),S()}}};return Object.defineProperty(M,re,{value:m}),M},H=ie,oe=ne,ae=k,q={};let se=0;function ue(e,n){const r=`atom${++se}`,l={toString(){return(q?"production":void 0)!=="production"&&this.debugLabel?r+":"+this.debugLabel:r}};return typeof e=="function"?l.read=e:(l.init=e,l.read=ce,l.write=le),l}function ce(e){return e(this)}function le(e,n,r){return n(this,typeof r=="function"?r(e(this)):r)}const de=()=>{let e=0;const n=oe({}),r=new WeakMap,l=new WeakMap,_=H(r,l,void 0,void 0,void 0,void 0,n,void 0,(w,E,b,...A)=>e?b(w,...A):w.write(E,b,...A)),f=new Set;return n.m.add(void 0,w=>{f.add(w);const E=r.get(w);E.m=l.get(w)}),n.u.add(void 0,w=>{f.delete(w);const E=r.get(w);delete E.m}),Object.assign(_,{dev4_get_internal_weak_map:()=>(console.log("Deprecated: Use devstore from the devtools library"),r),dev4_get_mounted_atoms:()=>f,dev4_restore_atoms:w=>{const E={read:()=>null,write:(b,A)=>{++e;try{for(const[g,a]of w)"init"in g&&A(g,a)}finally{--e}}};_.set(E)}})};function fe(){return(q?"production":void 0)!=="production"?de():H()}let L;function ve(){return L||(L=fe(),(q?"production":void 0)!=="production"&&(globalThis.__JOTAI_DEFAULT_STORE__||(globalThis.__JOTAI_DEFAULT_STORE__=L),globalThis.__JOTAI_DEFAULT_STORE__!==L&&console.warn("Detected multiple Jotai instances. It may cause unexpected behavior with the default store. https://github.com/pmndrs/jotai/discussions/2044"))),L}export{ae as I,ue as a,ve as g};
